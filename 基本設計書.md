# **AnchorMind 基本設計書**

## **1\. システムアーキテクチャ**

本システムは、ReactによるSPA（シングルページアプリケーション）と、FastAPIによるREST API、SQLiteによるデータ永続化層で構成される。

### **構成要素**

* **Frontend**: React (Vite), Tailwind CSS, pdf.js  
* **Backend**: FastAPI (Python 3.10+)  
* **Database**: SQLite  
* **File Storage**: ローカルファイルシステム（PDFの実ファイルはサーバー側またはブラウザ側のパスで管理）

## **2\. 外部設計（UI/UX・インターフェース）**

### **2.1. 画面レイアウト構成**

#### **A. ダッシュボード画面**

* **ヘッダー**: アプリ名、設定ボタン、新規アップロードボタン。  
* **メインエリア**: 登録済みPDFのカード一覧（サムネイル、タイトル、最終閲覧日、メモ数）。

#### **B. メインエディタ画面（3カラム構成）**

1. **左サイドバー（ナビゲーション）**:  
   * 全ページのミニサムネイル一覧。  
   * 各サムネイル上に、メモ密度に応じたヒートマップ（赤〜青のオーバーレイ）を表示。  
2. **中央（PDFビューア）**:  
   * pdf.js を利用したメイン表示エリア。  
   * クリックした位置に一時的なピン（マーカー）を表示。  
3. **右サイドバー（エディタ・リスト）**:  
   * 上部：検索バーとフィルタ。  
   * 中部：既存メモのリスト（クリックでPDFがジャンプ）。  
   * 下部：Markdownエディタ（入力エリアとリアルタイムプレビュー）。

### **2.2. 画面遷移図**

1. **初期表示** → \[ダッシュボード\]  
2. \[ダッシュボード\]でPDFを選択 → \[メインエディタ\]  
3. \[メインエディタ\]で「戻る」ボタン → \[ダッシュボード\]  
4. 各画面 → \[設定画面\]

## **3\. 内部設計（データ・ロジック）**

### **3.1. データベース設計 (Entity Relationship)**

#### **documents テーブル（PDF管理）**

| カラム名 | 型 | 制約 | 説明 |
| :---- | :---- | :---- | :---- |
| id | UUID | PK | 文書の一意識別子 |
| title | String | Not Null | ファイル名 |
| file\_hash | String | Unique | 同一ファイル検知用のSHA-256 |
| file\_path | String | Not Null | ローカルまたはサーバー上の保存パス |
| created\_at | DateTime |  | 登録日時 |

#### **notes テーブル（メモ・アンカー管理）**

| カラム名 | 型 | 制約 | 説明 |
| :---- | :---- | :---- | :---- |
| id | Integer | PK, Auto | メモID |
| doc\_id | UUID | FK | documents.id に紐付け |
| content | Text |  | Markdown形式の本文 |
| page\_num | Integer |  | PDFのページ番号（1開始） |
| x\_percent | Float |  | ページ内横位置 (0-100%) |
| y\_percent | Float |  | ページ内縦位置 (0-100%) |
| category | String |  | 分類タグ（序論、手法等） |
| updated\_at | DateTime |  | 最終更新日時 |

### **3.2. API エンドポイント設計**

| Method | Path | 説明 |
| :---- | :---- | :---- |
| GET | /api/docs | 登録済みPDF一覧の取得 |
| POST | /api/docs/upload | PDFのアップロードとハッシュ生成 |
| GET | /api/docs/{id}/notes | 特定PDFに紐付く全メモの取得 |
| POST | /api/api/notes | 新規メモ（アンカー付き）の保存 |
| PUT | /api/notes/{id} | メモ内容の更新 |
| DELETE | /api/notes/{id} | メモの削除 |

### **3.3. コアロジック：座標計算アルゴリズム**

ズーム倍率や画面サイズに依存しないよう、座標は「ページサイズに対するパーセンテージ」で管理する。

1. **取得時 (Frontend)**:  
   * クリック位置の clientX, clientY を取得。  
   * PDFページのDOM要素 getBoundingClientRect() から相対位置を算出。  
   * (相対座標 / ページ表示サイズ) \* 100 でパーセントに変換。  
2. **再現時 (Frontend)**:  
   * ページ番号へスクロール。  
   * ページの現在の表示サイズにパーセントを掛け合わせ、スクロール位置を微調整。

## **4\. 特筆すべき実装仕様**

### **4.1. ヒートマップの生成ロジック**

* 各ページの page\_num ごとに notes の件数をカウント。  
* カウント数に基づき、CSSの opacity または background-color (rgba) を決定。  
* 例：0件 \= 透明, 1-3件 \= 薄い青, 4-10件 \= 黄色, 10件以上 \= 赤。

### **4.2. Markdownプレビュー**

* react-markdown と remark-math / rehype-katex を使用し、$\\LaTeX$ 数式をレンダリング可能にする。

## **5\. 将来の拡張性への配慮**

* **AI連携**: notes 保存時に、content と該当ページのテキスト（pdf.js の getTextContent で抽出）をGemini APIに投げるジョブをバックエンドに予約できるようにインターフェースを定義しておく。